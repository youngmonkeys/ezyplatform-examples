<!--
 ~ Copyright 2022 youngmonkeys.org
 ~ 
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~ 
 ~   https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~ 
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{ezytheme}">
<body>
<div layout:fragment="content" class="container mt-3 mb-3">
  <div class="row">
    <div class="col-lg-2"></div>
    <div class="col-lg-8 overflow-wrap-anywhere">
      <div class="input-group input-group-lg my-3">
        <input type="search" class="form-control rounded-0"
               th:placeholder="#{keyword}" id="blogSearchKeyword"
               th:aria-label="keyword" aria-describedby="blog-search-input"
               th:value="${blogSearchKeyword}"
               onkeydown="onKeydownToSearchBlogItems(this);">
        <span class="input-group-text rounded-0 text-primary" id="blog-search-input">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>
      </div>
      <div class="row" id="blogListBody">
        <div th:each="blog : ${pagination.items}" class="col-md-12">
          <a class="post-item" th:href="${'/blog/' + blog.slug}">
            <div class="post-item-thumbnail">
              <img th:src="${blog.featuredImage != null ? blog.featuredImage.getUrlOrDefault('/images/logo.png') : '/images/logo.png'}">
            </div>
            <div class="post-item-content-wrapper">
              <h4 class="post-item-title">
                [[${blog.title}]]
              </h4>
              <div class="post-item-content">
                [[${blog.shortedContent}]]
              </div>
              <div class="post-item-metadata">
                <div>
                  [[#{posted_by_first_upper}]]: [[${blog.author.name}]]
                </div>
                <div>
                  [[#{date}]]:
                  <span class="date-string">[[${blog.publishedAt}]]</span>
                </div>
              </div>
            </div>
          </a>
        </div>
      </div>
      <div th:if="${pagination.continuation.hasNext}"  class="col-12 d-flex justify-content-center py-3" id="nextButtonContainer">
        <button type="button" class="btn btn-outline-primary px-5" onclick="fetchBlogList('next')">
          [[#{load_mores}]]
        </button>
      </div>
    </div>
    <div class="col-lg-2"></div>
  </div>
</div>
<script layout:fragment="scripts" th:inline="javascript">
/*<![CDATA[*/
var blogSearchTerm = /*[[${blogSearchTerm}]]*/ '';
var blogSearchKeyword = /*[[${blogSearchKeyword}]]*/ '';
var lastBlogPageToken = {};
lastBlogPageToken.next = /*[[${pagination.pageToken.next}]]*/ '';
ezyweb.messages.date = /*[[#{date}]]*/ '';
ezyweb.messages.posted_by_first_upper = /*[[#{posted_by_first_upper}]]*/ '';
/*]]>*/

//================ search ================
var onKeydownToSearchBlogItems = function(e) {
    if(event.key === 'Enter') {
        blogSearchKeyword = $(e).val();
        fetchBlogList();
        changeBrowserUrl();
    }
}

var changeBrowserUrl = function() {
    var params = [];
    if (blogSearchTerm) {
        params.push('term=' + blogSearchTerm);
    }
    if (blogSearchKeyword) {
        params.push('keyword=' + blogSearchKeyword);
    }
    if (ezyweb.lang) {
        params.push('lang=' + ezyweb.lang);
    }
    var url = '/blogs';
    if (params.length) {
        url += '?' + params.join('&');
    }
    window.history.pushState({}, '', url);
}

//================ blog list =============
var fetchBlogList = function (action) {
  var queryString = '';
  if (blogSearchTerm) {
    queryString += '&term=' + blogSearchTerm;
  }
  if (blogSearchKeyword) {
    queryString += '&keyword=' + blogSearchKeyword;
  }
  if (action == 'next') {
    if (lastBlogPageToken.next) {
      queryString += '&nextPageToken=' + lastBlogPageToken.next;
    } else {
      return;
    }
  }
  if (ezyweb.lang) {
    queryString += '&lang=' + ezyweb.lang;
  }
  $.ajax({
    url: '/api/v1/blogs?limit=12' + queryString,
    type: 'GET',
    dataType: 'json'
  })
  .done(function (data) {
    lastBlogPageToken = data.pageToken;
    var html = buildBlogListBodyHtml(data.items);
    if (action == 'next') {
      $('#blogListBody').append(html);
    } else {
      $('#blogListBody').html(html);
    }
    if (!data.continuation.hasNext) {
      $('#nextButtonContainer').remove();
    }
  })
  .fail(function (e) {
    ezyweb.processGetApiErrors(e);
  });
}

var buildBlogListBodyHtml = function (blogList) {
  var html = '';
  blogList.forEach((blog) => {
    html += buildBlogListItemHtml(blog);
  });
  return html;
}

var buildBlogListItemHtml = function (blog) {
  var html = `
  <div class="col-md-12">
    <a class="post-item" href="${'/blog/' + blog.slug}">
      <div class="post-item-thumbnail">
        <img src="${ezyweb.extractMediaUrl(blog.featuredImage) || '/images/logo.png'}">
      </div>
      <div class="post-item-content-wrapper">
        <h4 class="post-item-title">
          ${blog.title}
        </h4>
        <div class="post-item-content">${blog.shortedContent}</div>
        <div class="post-item-metadata mt-2">
          <div>
            ${ezyweb.messages.posted_by_first_upper}: ${blog.author.name}
          </div>
          <div>
            ${ezyweb.messages.date}:
            <span class="date-string">${ezyweb.formatTimeStamp(blog.publishedAt, 'YYYY-MM-DD')}</span>
          </div>
        </div>
      </div>
    </a>
  </div>
  `;
  return html;
}
</script>
</body>
</html>
